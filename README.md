# /data storage devices/ Thread FAQ

### TL;DR процветающий шапка

**Q: Я простой рабочий Иван город Тверь, желать ставить много игры и распространять много хвалебные материалы твёрдый стержень товарищ Xi, что вы можете подсказывать?**

A: Любой накопитель на основе CMR технологии, не обладающий собственными технологиями энергосбережения:
- WD: Purple, Black, Gold, SE, Red Pro (?)
- Seagate: SkyHawk, Constellation, IronWolf(?), Exos [Таблица производителя](http://https://www.seagate.com/ru/ru/internal-hard-drives/cmr-smr-list/ "Таблица производителя")
- Toshiba: P300 (HDWD1xxx), ряд S300 (см. сводку), xxxx**ACA** (наследие Hitachi, некоторые модели SMR!)
- Гелиевые диски от WD и Hitachi (статистики по ним пока ещё нет)

[Пользовательская сводка SMR/CMR](https://nascompares.com/answer/list-of-wd-cmr-and-smr-hard-drives-hdd/ "Пользовательская сводка SMR/CMR")

**Q: Что сказать про SMR диск, магазин количество много цена весьма низкий?**

A: Некачественный убыток тайваньский собака, много отключения и слабый скорость, голова болит от проблем.

**Q: Что насчет внешний? Архивировать каждый запись созыв компартии, полка хранение, просвещать подрастающее поколение.**

A: Практически все современные внешние ЖД собираются на основе SMR дисков самых отстойных линеек, проблемы всё те же самые. Их надёжность вызывает вопросы. 

**Q: Хотеть надежность! Запись созыв компартии ценный материал!**

A: Ни один из современных производителей ЖД не гарантирует надёжность хранения данных. Хочешь быть спокойным за свой архив - храни их в нескольких хранилищах одновременно: RAID1/5/6, облака, оптические, ленточные накопители.

**Q: Выглянуть на барахолку, много вкусный предложения, подводный камень?**

A: Неизвестно как эксплуатировавшиеся, возможно падавшие, диски без тестов. Не стоит принимать к рассмотрению.

**Q: Обладать старый записная книжка, какой накопитель посоветовать?**

A: Практически все современные ноутбучные диски идут с SMR и в качестве основного накопителя не годятся. С учётом же уравнения цен на гигабайт вообще рекомендуется рассмотреть вариант покупки SSD.

### Как взять жёсткий диск и не наебаться

Прежде всего стоит понимать, что после широкого распространения твердотельных накопителей потребительский сегмент HDD сходит на нет, соответственно, производители всё больше экономят на проектировании и производстве накопителей данного класса. Также стоит учитывать конъюнктуру рынка: в основном жёсткие диски берут люди а) которым не хватает денег на ёмкий SSD, а все игры ставить куда-то нужно; б) под большой массив генерируемых пользователем данных - NAS, видеонаблюдение в) энтузиасты, собирающие/раздающие какие-либо аудио/видео/программные/иные материалы, под которые неминуемо требуются дисковые пространства и SSD для данных случаев просто не подходит; г) майнинг на фоне очередной волны спекуляций на криптовалютных биржах; д) для сборки бюджетного комплекта и последующей перепродажи. Первые два не предъявляют каких-либо особенных требований ни к работе диска на запись, ни к работе диска на чтение, что в принципе понимается производителями как отсутствие потребности в оных вообще. В случае же с пунктом "в" количество энтузиастов исчезающе мало для какого-либо влияния на рынке, а про последний говорить, полагаю, не имеет смысла.



По этой самой причине сначала Seagate, а потом и остальные участники рынка, внедрили технологию черепичной записи (SMR). Подробности этой технологии ты, при желании, найдешь в интернете, но для вопроса выбора накопителя под свои задачи главное, что стоит иметь ввиду - низкая производительность в ряде задач, в первую очередь на операциях записи. В отличие от накопителя с традиционной записью (PMR/CMR), в котором есть две сущности - оперативная память для небольшого кэша операций и собственно магнитная пластина для данных, в диске с черепичкой введена так же третья сущность - CMR кэш (Media Cache), на который непосредственно пишутся подаваемые на диск данные, а уже потом распределяются по черепичной области, для чего также увеличена оперативная память, т.к. при обновлении данных на пластине требуется заново переписать некоторое количество уже имеющихся данных, и всё это дело нужно где-то хранить. В чём-то SMR напоминает современный ссд с SLC кэшем, но, в отличие от последнего, задержки между обращениями заметно больше. Фактически же при активной записи диск с черепичкой гоняет блок головок там, где диск с традиционной записью просто пишет данные в линию. Более того, по исчерпанию CMR кэша диск начинает активно писать (скидывать кэш) в SMR область, что может сильно провалить скорость, в зависимости от данных, которые на него копируются, вплоть до единиц мегабайт. При чтении особых проблем не возникает ввиду устройства блока головок, но в смешанном режиме всё тоже будет достаточно печально.

В конечном итоге при покупке диска SMR имеем:
- просаженную производительность диска при длительной записи
- повышенную скорость износа актуатора блока магнитных головок
- лучшую энергоэффективность за счет меньшего количества пластин (весьма спорный момент)



Разница в цене между дисками с SMR и CMR технологиями записи может достигать 20%, но может и не достигать. Если ты собираешься использовать диск для частой записи - скидывание видосов с попоек, торрентокачалка, использование в СХД и с использованием RAID и/или применением журналируемых ФС, хранение основной копии БД от региональной наноборды и т.д. - диск с SMR технологией определенно не для тебя. В остальных случаях стоит оценить ситуацию на рынке и понять, есть ли смысл в экономии пары сотен рублей. В целом, SMR скорее способ явной экономии чем инновация.

Тесты по теме:

[Диски высокой ёмкости](https://www.hardwareluxx.ru/index.php/artikel/hardware/storage/49812-cmr-protiv-smr-vyvodim-proizvoditelej-hdd-na-chistuyu-vodu.html)

[Тест WD20EZAZ](https://www.ixbt.com/live/data/beglyy-obzor-zhestkogo-diska-wd-blue-wd20ezaz-emkost-2tb.html)

[Сравнение в графиках](https://habr.com/ru/post/529860/)


### SSHD, RPM, APM, AAM и прочие аббревиатуры

В те времена, когда мониторы были большие, экраны маленькие, Билл Гейтс еще возглавлял совет директоров одной маленькой мягкой фирмы и рвал волосы от сорванных сроков по релизу очередной пушки-гонки с нескучными обоями, а скорости тогдашних накопителей едва-ли превышали таковые у рядовой китайской флешки с алиэкспресса, эти самые накопители поддерживали ряд конфигурируемых (и нет) пользователем технологий, управляющих шумом, нагревом и скоростями. Те времена давно прошли, технологии забыты, поэтому единственное, что тебе стоит принимать во внимание - скорость вращения магнитных пластин (RPM) и поддержка ошметков технологии APM.

От скорости вращения напрямую зависит скорость доступа к секторам в пределах одного семейства и, как не совсем очевидное следствие - нагрев накопителя, если 5400RPM диск при комнатной температуре в 20 градусов нагревается весьма слабо - до 30-35 градусов, и в каких-либо дополнительных телодвижениях не нуждается, то 7200RPM собрат практически всегда набирает 45 и выше, в связи с чем его длительная работа без активного обдува нежелательна (обычно верхняя граница допустимой температуры у накопителей порядка 50 градусов). В случае же потребительских характеристик 7200RPM не так уж интересен ввиду отсутствия заметной прибавки в производительности, фактически после того, как человечество перестало использовать жесткий диск в качестве системного с хранением на нём файла подкачки (swap), эта самая необходимость попросту отвалилась. Если ты крутишь какой-либо сервис, требующий разбещения своих данных на жестком диске и активного к ним обращения - посмотри на связку HDD + SSD + flashcache (если пердоля) или сопоставимый аналог под Windows (PrimoCache? Сам найдешь).


Ошмётки AAM в свою очередь проявляются в наличии автопарковки блока головок при бездействии энное количество времени во имя защиты данных от предательского толчка рукой/ногой в крышку системного блока. Имеются они не на всех дисках: например, самые ходовые диски от WD линеек Green и, теперь уже, Blue обладают зашитым интервалом автопарковки в 8 секунд; Red диски от того же производителя имеют более щадящий интервал - около 48 секунд или выше; Purple, Black, Red Pro, Gold таким механизмом не обладают; накопители 2.5" (ноутбучного) формата любого производителя обладают минимальными интервалами для минимизации выхода из строя при падении ноутбука. Основные проблемы, к которым приводит малый интервал автопарковки - подлагивания при обращении из-за постоянной парковки-распарковки головок, и износ актуатора. При редких обращениях к содержимому диска особой погоды не составляют, но в качестве ёмкого накопителя в компьютер под контент всякого рода такие диски - не лучший выбор. Особняком стоят ноутбучные варианты, там выбрать особо не из чего.


Последняя, не столь старая, но уже вымирающая сама по себе технология - гибридные накопители SSHD. Сказать за них особо нечего, смысл покупки таковых с расчётом на повышенную производительность исчезающе мал - SSD кэш недостаточно ёмкий чтобы покрыть какую-то часть особо востребованных операций чтения, однако он может быть полезен для массивов с расчетом на частую случайную запись, например, используемых в качестве торрентокачалки. Кроме того, NAND подвержен износу, что приведёт к проблемам в будущем. Просто напомню про flashcache, и закроем эту тему.

### Проверка и обслуживание

Надёжность у современных дисков так себе, особенно если речь идёт про хранилище важных данных, поэтому следует периодически проверять их состояние. Кроме того, рекомендуется сделать проверку сразу после покупки накопителя, особенно если ты таки решил взять HDD с рук. Для этого в интернете можно найти массу утилит, самые ходовые из них `smartctl` и его графическая оболочка `gsmartcontrol`, `Victoria`, `CrystalDiskInfo`. Как это делать:

#### Оценка состояния по SMART

Всё очень просто: качаешь наиболее подходящую тебе утилиту, делаешь опрос SMART-таблицы накопителя, смотришь результат. Например, `smartctl -A /dev/sdb`.

Самые важные показатели:
- **05 - Reallocated Sectors Count** - количество переназначенных секторов. Для побывавших в эксплуатации старых дисков десяток-второй бэд-блоков нормальное явление и в целом, если показатель не растёт, можно быть относительно спокойным. В случае же новодела же появление даже единиц таковых - тревожный звоночек, и данные нужно переносить, а состоянию диска - уделять пристальное внимание.
- **C5 - Current Pending Sector Count** - количество секторов под вопросом. Тут одно из двух: или они в будущем пойдут в 05, или в процессе исправятся и просто покинут этот список. Как правило сей показатель говорит о наличии программных бэд-секторах, часто появляющихся при отключении света во время записи на диск. С большой степенью вероятности исправятся путём банальной перезаписи.
- **С7 - UltraDMA CRC Error Count** - отвечает за регистрацию ошибок на интерфейсном уровне. Если у тебя данный показатель отличен от нуля - повод сменить шлейф на нормальный с защёлками да последить за PCH материнской платы, перегрев или переразгон (если таковой произведён) по шине могут давать сбои в передаче данных.
- **С2 - Temperature** - температура накопителя, собственно. Как правило, сам регистр показывает погоду на Марсе, но любой софт это дело парсит и выводит значение температуры отдельно. Есть не слишком свежий [статистический график](https://en.wikibooks.org/wiki/Minimizing_Hard_Disk_Drive_Failure_and_Data_Loss/Environmental_Control), можешь ориентироваться по нему. Вряд ли у тебя дома температуры ниже минимально комфортной для человека без шубы, посему главная задача - не перегревать накопитель. Оптимальная температура - 35-40 градусов, но и от 30 градусов никто не умрёт, а вот циклический прогрев накопителя до 50 градусов может негативно сказаться на его самочувствии.
- **09 - Power-On Hours** - время наработки диска. Статистический параметр, у новья он должен стремиться к нулю, но пара-тройка часов работы - нормальное дело, диск проходил тестирование у производителя. Практически любой диск способен отработать 20...50k и больше часов, были замечены долгожители с наработкой более 100к часов.
- **С1 - Load/Unload Cycle Count** - количество парковок/распарковок блока магнитных головок. У новья тоже должен стремиться к нулю; у повидавшего жизнь диска может достигать сотен тысяч раз в зависимости от модели. Напомню, WD гарантирует 300k парковок, выше идёт "как повезёт".

Все остальные показатели, кроме 03 и 04, **должны быть по нулям**! Исключение составляют диски Seagate - они регистрируют каждый чих, поэтому можно наблюдать многомиллионные значения ряда параметров у даже 146% нового диска.

Для WD также важны следующие показатели:
- **01 - Read Error Rate** - ошибки чтения. Фактически отвечает за состояние поверхности пластин(ы) и считывающих головок. Если он оказался выше нуля, то это повод переносить данные, а если он ушёл за сотку - диск не способен хранить записываемые на него данные. Как правило сопровождается растущим показателем C5.
- **С8 - Write Error Rate** - та же шляпа, вид сбоку. Начинает проявляться уже после 01 и говорит о приходящем писце. На этом этапе диск можно выбрасывать, если только ты не спец в редактировании модулей служебки, способный отключить сбойную головку или подкрутить усиление.
- **07 - Seek Error Rate** - говорит о проблемах позиционирования головок, износ актуатора. Решения те же, что и в предыдущих пунктах.

#### Self-сканирование

Статистику ни с чего не сформируешь, если накопителем редко пользуются. В свою очередь, для получения исчерпывающих данных требуется эти данные собрать со всей поверхности каждой пластины, что в бытовых условиях использования практически невозможно, иначе снятые показатели не будут репрезентативными. Поэтому для облегчения решения этого вопроса в микропрограмму жестких дисков добавляют две крайне полезные функции - набор self-тестов и автоматический сбор данных во время простоя диска.

Автоматический сбор данных присутствует в дисках практически всех производителей, однако не во всех дисках он задействован по умолчанию. Проверить это можно с помощью команды `smartctl -c /dev/sdX`, по состоянию настройки `Auto Offline Data Collection`:

```
Offline data collection status:  (0x82) Offline data collection activity
                                        was completed without error.
                                        Auto Offline Data Collection: Enabled.
```

Если диск стоит в компьютере, то данную функцию следует задействовать: `smartctl --offlineauto=on /dev/sdX`. Если же диск преимущественно хранится на полке, пользы от неё не будет.

Набор тестов также присутствует во всех накопителях и позволяет принудительно запустить обследование состояния накопителя. Тестов много, но нам интересен только один - полный. Полный тест производит сканирование всего объема и занимает времени не меньше времени полного линейного чтения; часто ожидаемое время указывается в той же стопке данных, в которой указано состояние функции автоматического сбора:

```
Total time to complete Offline
data collection:                (26580) seconds.
```

Для запуска данного теста следует выполнить команду `smartctl -t long /dev/sdX`, после чего можно отслеживать процесс через уже знакомую команду `smartctl -c /dev/sdX`:

```
Self-test execution status:      ( 249) Self-test routine in progress...
                                        90% of test remaining.
```

По завершению теста этот самый пункт покажет общий результат выполнения, а SMART-лог обновится новыми показателями, если в накопителе произошли какие-либо изменения.

Стоит заметить, что любое обращение к диску останавливает, а то и отменяет, самотестирование, поэтому данный тест стоит проводить в моменты покоя компьютера - перед сном там, например. Есть более кардинальный вариант - `captive`, после запуска которого диск перестаёт отвечать на запросы; это грозит выпаданием диска из системы. Если согласен на такой исход: `smartctl -t -C long /dev/sdX`. Ещё один неочевидный недостаток данной функции - самотестирование прекращается при обнаружении первой ошибки чтения, т.е. такой вариант может не подойти для уже имеющих бэд-блоки дисков (в зависимости от модели диска). Также, очевидно, проблемы могут быть с дисками, на которых стоит система.

Виндовозникам доступо управление и отслеживание прогресса теста в последней `Victoria`: Меню-Сервис-Операции Смарт. Не забудь поставить галку периодического опроса! Или `gsmartcontrol`.

#### Сканирование подручными средствами

Наконец, третий, бесперебойный вариант - просто просканировать поверхность диска самостоятельно. Берешь `Victoria` или `whdd`, можешь даже `dd` - только операнды между собой не перепутай, и запускаешь чтение. Если диск **100%** не имеет влияния извне - качание торрентов, просмотр картинок, опрос температуры HwInfo, дефрагментации винды и т.д. и т.п. - по графику/статистике (у `dd` их нет, само собой) можно оценивать не только количество бэдблоков но и общую картину по состоянию жесткого диска (опять же, если это не показывающий скорость ветра на Марсе SMR), но с огромной степенью вероятности у тебя стерильных условий не будет, а потому за каракули особо беспокоиться не стоит. Главное - полное чтение поверхности. Через несколько минут после завершения операции заглядываешь SMART и смотришь что изменилось. Как и было? Отлично. Что-то не так? Смотришь описание параметров выше и принимаешь меры.



Общая рекомендация автора этих строк - проводить тестирование накопителя с ценными данными раз в пару недель-месяц. Если накопитель отлёживается в сухом прохладном месте и редко достаётся из каморки - желательно каждое подключение. Ты ведь не хочешь внезапно узнать, что все твои сохранёнки редких пепесов превратились в труху, правда?

### Извлечение и восстановление данных

Данный раздел будет весьма кратким, т.к. вариантов у владельца осыпающегося накопителя не так много. В этом вопросе главное помнить: не делать лишних необдуманных движений, восстановление данных в специализированном сервисном центре стоит цены нескольких таких дисков. Если данные весьма важны и в своих силах не уверен, то лучше всего отнести в этот самый **нормальный!** СЦ. Дешевле выйдет.

Прежде всего требуется снять образ диска с помощью любой утилиты, позволяющей игнорировать ошибки чтения, к примеру, `ddrescue`. В дальшейшем его можно раскатать на новый накопитель той же или большей ёмкости (с некоторыми оговорками) или же работать непосредственно с самим образом. Хорошие инструменты:
- photorec - ищет по сигнатурам, извлекает в одну кучу с неразборчивыми именами. Подходит, когда утрачена MFT/разметка разделов.
- R-Studio - неплохо работает при наличии живой MFT/разметки, восстанавливает недавно удалённые файлы НО платый.
- qemu-img - если образ снят с диска, на котором еще определялись разделы, копию образа можно преобразовать в образ виртуального диска, подходящего для определенной виртуальной машины [возможности](https://docs.openstack.org/image-guide/convert-images.html).
- допишите сюда чем успешно восстанавливали фоточки милф с б/ушных дисков

Если же с диском всё в порядке, однако "винда пожрала нашу разметку, милорд", можно воспользоваться `testdisk` - в большинстве случаев он способен восстановить удалённые разделы.

### Покупка Б/У дисков с рук

*to be continued*

### Решение проблем

*to be continued*

### Накопители для холодного хранения данных

*to be continued*
